# Dockerfile - Optimized for GKE Autopilot
FROM python:3.11-slim AS builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt && \
    pip install --user --no-cache-dir --force-reinstall "fastmcp>=2.14.0" "jaraco.context>=6.1.0" "wheel>=0.46.2" && \
    find /root/.local -name "node_modules" -type d -exec rm -rf {} +

FROM python:3.11-slim
WORKDIR /app

# Upgrade system packages to fix vulnerabilities
RUN pip install --no-cache-dir --upgrade "wheel>=0.46.2"

# Install CA certificates for SSL/TLS connections (required for MongoDB Atlas)
RUN apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Security: Create non-root user with home directory
RUN groupadd -r parlant && useradd -r -g parlant -u 1000 -m -d /home/parlant parlant

# Copy Python packages from builder
COPY --from=builder /root/.local /home/parlant/.local

# Copy application code
COPY *.py .

# Create data directory that the app needs and set ownership
RUN mkdir -p /app/parlant-data && \
    chown -R parlant:parlant /app && \
    chown -R parlant:parlant /home/parlant

ENV PATH=/home/parlant/.local/bin:$PATH

# Security: Switch to non-root
USER parlant

EXPOSE 8800
CMD ["sh", "-c", "python ${PARLANT_ENTRYPOINT:-main.py}"]